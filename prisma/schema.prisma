generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum SocialPlatform {
  Instagram
  TikTok
  Facebook
  YouTube
}

enum AuthUserType {
  CLIENT
  SHOP
  ADMIN
}

enum AuthUserStatus {
  ACTIVE
  SUSPENDED
}

enum AdminRole {
  SUPERADMIN
  MODERATOR
}

enum AdminStatus {
  ACTIVE
  SUSPENDED
}

enum QuotaResource {
  LIVE
  REEL
}

enum QuotaDirection {
  CREDIT
  DEBIT
}

enum QuotaReason {
  PLAN_BASE
  PURCHASE
  MANUAL_COMP
  MISSED_BURN
  CANCEL_BURN
  REPROGRAM
  ADMIN_OVERRIDE
  EXPIRED_REEL
  LEGACY_MIGRATION
}

enum QuotaRefType {
  PURCHASE
  LIVE
  ADMIN
  SYSTEM
}

enum QuotaActorType {
  ADMIN
  SHOP
  SYSTEM
}

enum PurchaseType {
  LIVE_PACK
  REEL_PACK
  PLAN_UPGRADE
}

enum PurchaseStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ShopStatus {
  PENDING_VERIFICATION
  ACTIVE
  AGENDA_SUSPENDED
  HIDDEN
  BANNED
}

enum StreamStatus {
  UPCOMING
  LIVE
  FINISHED
  MISSED
  CANCELLED
  BANNED
  PENDING_REPROGRAMMATION
}

enum ReportStatus {
  OPEN
  VALIDATED
  REJECTED
}

enum LiveScheduleAction {
  CREATE
  EDIT
  CANCEL
  AUTO_REPROGRAM
  SET_PENDING_REPROGRAM
  ADMIN_OVERRIDE
  AUTO_START
  AUTO_FINISH
}

enum AuditEntityType {
  SHOP
  LIVE
  REEL
  PURCHASE
  SUSPENSION
  NOTIFICATION
}

enum NotificationType {
  SYSTEM
  REMINDER
  PURCHASE
}

enum ReminderStatus {
  ACTIVE
  CANCELED
  SENT
}

enum NotificationStatus {
  QUEUED
  SENT
  FAILED
  CANCELED
}

enum ReelType {
  VIDEO
  PHOTO_SET
}

enum ReelStatus {
  ACTIVE
  PROCESSING
  EXPIRED
  HIDDEN
}

model AuthUser {
  id           String          @id @default(uuid())
  email        String          @unique
  passwordHash String?
  userType     AuthUserType
  status       AuthUserStatus  @default(ACTIVE)
  createdAt    DateTime        @default(now())
  lastLoginAt  DateTime?

  shop         Shop?
  admin        Admin?
  client       Client?
  reviews      Review[]
  reports      Report[] @relation("ReportUser")
  favorites    Favorite[]
  agenda       Agenda[]
  notifications Notification[]
  reelViews    ReelView[]
  streamLikes  StreamLike[]
}

model Admin {
  authUserId  String      @id
  authUser    AuthUser    @relation(fields: [authUserId], references: [id])
  role        AdminRole   @default(MODERATOR)
  adminStatus AdminStatus @default(ACTIVE)
  createdAt   DateTime    @default(now())
  approvedPurchaseRequests PurchaseRequest[] @relation("ApprovedByAdmin")
  createdAgendaSuspensions AgendaSuspension[] @relation("AgendaSuspensionCreatedBy")
  reviewedReports Report[] @relation("ReportReviewedBy")
}

model Client {
  authUserId  String   @id
  authUser    AuthUser @relation(fields: [authUserId], references: [id])
  displayName String?
  avatarUrl   String?
  createdAt   DateTime @default(now())
}

model User {
  id            String         @id @default(uuid())
  name          String
  email         String         @unique
  createdAt     DateTime       @default(now())
}

// Dentro de prisma/schema.prisma

model Shop {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  logoUrl         String?
  coverUrl        String?
  website         String?
  authUserId      String?  @unique
  requiresEmailFix Boolean @default(false)
  authUser        AuthUser? @relation(fields: [authUserId], references: [id])
  
  // --- NUEVOS CAMPOS LEGALES ---
  razonSocial     String?
  cuit            String?
  email           String?  @unique
  password        String?
  address         String?
  addressDetails  Json?
  minimumPurchase Int?     @default(0)
  paymentMethods  String[]
  // -----------------------------

  plan            String   @default("BASIC")
  status          ShopStatus @default(PENDING_VERIFICATION)
  statusReason    String?
  statusChangedAt DateTime?
  ownerAcceptedAt DateTime?
  agendaSuspendedUntil DateTime?
  agendaSuspendedByAdminId String?
  agendaSuspendedReason String?
  streamQuota     Int      @default(0)
  reelQuota       Int      @default(0)
  active          Boolean  @default(true)
  
  // Relaciones
  streams         Stream[]
  reels           Reel[]
  penalties       Penalty[]
  socialHandles   ShopSocialHandle[]
  whatsappLines   ShopWhatsappLine[]
  favorites       Favorite[]
  reviews         Review[]
  reports         Report[]
  aggregate       ShopAggregate?
  quotaWallet     QuotaWallet?
  quotaTransactions QuotaTransaction[]
  purchaseRequests PurchaseRequest[]
  agendaSuspensions AgendaSuspension[]
  liveScheduleEvents LiveScheduleEvent[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ... (deja el resto de los modelos Stream, Reel, etc. como estaban)

model Stream {
  id          String    @id @default(uuid())
  shopId      String
  shop        Shop      @relation(fields: [shopId], references: [id])
  title       String
  description String?
  status      StreamStatus @default(UPCOMING)
  scheduledAt DateTime     @default(now())
  scheduledEndPlanned DateTime?
  timezone    String   @default("America/Argentina/Buenos_Aires")
  startTime   DateTime?
  endTime     DateTime?
  durationMinutes Int?
  cancelledAt DateTime?
  cancelReason String?
  hidden      Boolean   @default(false)
  visibilityReason String?
  platform    SocialPlatform @default(Instagram)
  url         String?
  extensionCount Int   @default(0)
  likes       Int      @default(0)
  reportCount Int      @default(0)
  editCount   Int      @default(0)
  lastEditedAt DateTime?
  originalScheduledAt DateTime?
  reprogrammedFromId String?
  reprogramReason String?
  pendingReprogramNote String?
  reprogramBatchId String?
  reports     Report[]
  reviews     Review[]
  agenda      Agenda[]
  streamLikes StreamLike[]
  scheduleEvents LiveScheduleEvent[]
  createdAt   DateTime  @default(now())
}

model StreamLike {
  id       String   @id @default(uuid())
  streamId String
  stream   Stream   @relation(fields: [streamId], references: [id])
  userId   String
  user     AuthUser @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@unique([streamId, userId])
}

model Reel {
  id        String   @id @default(uuid())
  shopId    String
  shop      Shop     @relation(fields: [shopId], references: [id])
  type      ReelType   @default(VIDEO)
  videoUrl  String?    @map("videoUrl")
  photoUrls String[] @default([])
  thumbnailUrl String?
  presetLabel String?
  durationSeconds Int @default(10)
  status    ReelStatus @default(ACTIVE)
  processingJobId String? @unique
  platform  SocialPlatform @default(Instagram)
  hidden    Boolean  @default(false)
  views     Int      @default(0)
  createdAt DateTime @default(now())
  expiresAt DateTime @default(now())
  reelViews ReelView[]
}

model ShopSocialHandle {
  id        String         @id @default(uuid())
  shopId    String
  shop      Shop           @relation(fields: [shopId], references: [id])
  platform  SocialPlatform
  handle    String
  createdAt DateTime       @default(now())

  @@unique([shopId, platform])
}

model ShopWhatsappLine {
  id        String   @id @default(uuid())
  shopId    String
  shop      Shop     @relation(fields: [shopId], references: [id])
  label     String
  number    String
  createdAt DateTime @default(now())
}

model Review {
  id        String   @id @default(uuid())
  streamId  String
  stream    Stream   @relation(fields: [streamId], references: [id])
  shopId    String?
  shop      Shop?    @relation(fields: [shopId], references: [id])
  userId    String
  user      AuthUser @relation(fields: [userId], references: [id])
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  @@unique([streamId, userId])
}

model Report {
  id        String   @id @default(uuid())
  streamId  String
  stream    Stream   @relation(fields: [streamId], references: [id])
  shopId    String?
  shop      Shop?    @relation(fields: [shopId], references: [id])
  userId    String
  user      AuthUser @relation("ReportUser", fields: [userId], references: [id])
  reason    String
  status    ReportStatus @default(OPEN)
  resolved  Boolean  @default(false)
  reviewedByAdminId String?
  reviewedByAdmin   Admin?   @relation("ReportReviewedBy", fields: [reviewedByAdminId], references: [authUserId])
  reviewedAt        DateTime?
  createdAt DateTime @default(now())

  @@unique([streamId, userId])
}

model Penalty {
  id        String   @id @default(uuid())
  shopId    String
  shop      Shop     @relation(fields: [shopId], references: [id])
  reason    String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
}

model Favorite {
  id     String @id @default(uuid())
  userId String
  user   AuthUser   @relation(fields: [userId], references: [id])
  shopId String
  shop   Shop   @relation(fields: [shopId], references: [id])

  @@unique([userId, shopId])
}

model Agenda {
  id       String @id @default(uuid())
  userId   String
  user     AuthUser   @relation(fields: [userId], references: [id])
  streamId String
  stream   Stream @relation(fields: [streamId], references: [id])
  status   ReminderStatus @default(ACTIVE)
  notifyAt DateTime?
  createdAt DateTime @default(now())

  @@unique([userId, streamId])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      AuthUser     @relation(fields: [userId], references: [id])
  message   String
  type      NotificationType @default(SYSTEM)
  refId     String?
  notifyAt  DateTime?
  status    NotificationStatus @default(QUEUED)
  sentAt    DateTime?
  payload   Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model ReelView {
  id        String   @id @default(uuid())
  reelId    String
  reel      Reel     @relation(fields: [reelId], references: [id])
  userId    String
  user      AuthUser @relation(fields: [userId], references: [id])
  seenAt    DateTime @default(now())

  @@unique([reelId, userId])
}

model ShopAggregate {
  shopId      String   @id
  shop        Shop     @relation(fields: [shopId], references: [id])
  ratingAvg   Float    @default(0)
  ratingCount Int      @default(0)
  updatedAt   DateTime @updatedAt
}

model QuotaWallet {
  shopId             String @id
  shop               Shop   @relation(fields: [shopId], references: [id])
  weeklyLiveBaseLimit Int
  weeklyLiveUsed     Int
  weeklyLiveWeekKey  String
  liveExtraBalance   Int
  reelDailyLimit     Int
  reelDailyUsed      Int
  reelDailyDateKey   String
  reelExtraBalance   Int
}

model QuotaTransaction {
  txnId     String         @id @default(uuid())
  shopId    String
  shop      Shop           @relation(fields: [shopId], references: [id])
  resource  QuotaResource
  direction QuotaDirection
  amount    Int
  reason    QuotaReason
  refType   QuotaRefType?
  refId     String?
  actorType QuotaActorType
  actorId   String?
  createdAt DateTime       @default(now())
}

model PurchaseRequest {
  purchaseId        String         @id @default(uuid())
  shopId            String
  shop              Shop           @relation(fields: [shopId], references: [id])
  type              PurchaseType
  quantity          Int
  status            PurchaseStatus @default(PENDING)
  createdAt         DateTime       @default(now())
  approvedAt        DateTime?
  approvedByAdminId String?
  approvedByAdmin   Admin?         @relation("ApprovedByAdmin", fields: [approvedByAdminId], references: [authUserId])
  paymentProofUrl   String?
  notes             String?
  paymentProvider   String?
  paymentStatus     String?
  paymentRef        String?
  paymentPreferenceId String?
}

model AgendaSuspension {
  suspensionId      String   @id @default(uuid())
  shopId            String
  shop              Shop     @relation(fields: [shopId], references: [id])
  startAt           DateTime
  endAt             DateTime
  reason            String
  createdByAdminId  String?
  createdByAdmin    Admin?   @relation("AgendaSuspensionCreatedBy", fields: [createdByAdminId], references: [authUserId])
  createdAt         DateTime @default(now())
}

model LiveScheduleEvent {
  eventId          String             @id @default(uuid())
  liveId           String
  live             Stream             @relation(fields: [liveId], references: [id])
  shopId           String
  shop             Shop               @relation(fields: [shopId], references: [id])
  action           LiveScheduleAction
  fromScheduledAt  DateTime?
  toScheduledAt    DateTime?
  reason           String?
  actorType        QuotaActorType
  actorId          String?
  createdAt        DateTime           @default(now())
}

model AuditLog {
  auditId     String          @id @default(uuid())
  actorType   QuotaActorType
  actorId     String?
  action      String
  entityType  AuditEntityType
  entityId    String?
  meta        Json?
  createdAt   DateTime        @default(now())
}
